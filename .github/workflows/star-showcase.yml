name: 🌟 Update Star Showcase
on:
  schedule:
    # 每天早上 6 点运行
    - cron: '0 6 * * *'
  workflow_dispatch:

jobs:
  update-stars:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install jq
        # 仍然需要 jq 来解析 JSON
        run: sudo apt-get install -y jq

      - name: Fetch starred repos and generate Content
        # 使用多行脚本获取数据、生成 HTML 并存储在环境变量中
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          # 1. 初始化变量，包含标题
          STAR_SHOWCASE_CONTENT="## 🌟 Star Showcase\n\n"
          
          # 2. 添加外部容器的起始 HTML
          STAR_SHOWCASE_CONTENT="${STAR_SHOWCASE_CONTENT}<div align=\"center\" style=\"display:flex; flex-wrap:wrap; justify-content:center;\">\n"

          # 3. 抓取数据
          STARRED_REPOS=$(curl -s -H "Authorization: token $GH_TOKEN" "https://api.github.com/users/legendundery/starred?per_page=6")
          
          # 4. 定义 jq 脚本：使用单引号多行字符串来定义模板，减少转义问题
          # 注意：这里的单引号是 jq 的字符串，内层的双引号是 HTML 属性。
          JQ_SCRIPT='
            .[] | "
            <div style=\"width:280px; margin:10px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.08); padding:15px; background:#fff; text-align:left;\">
                <a href=\"\(.html_url)\" target=\"_blank\" style=\"text-decoration:none; color:#0969da;\">
                    <h3>\(.full_name)</h3>
                </a>
                <p style=\"color:#555; font-size:13px;\">\(.description // "No description")</p>
                <p style=\"font-size:12px; color:#888;\">⭐ \(.stargazers_count)</p>
            </div>"
          '
          
          # 5. 执行 jq 并将结果添加到内容变量
          # 使用 'echo' 和 'jq -r' 将模板和数据结合
          CARD_HTML=$(echo "$STARRED_REPOS" | jq -r "$JQ_SCRIPT")
          
          # 6. 将生成的卡片 HTML 添加到内容中
          STAR_SHOWCASE_CONTENT="${STAR_SHOWCASE_CONTENT}${CARD_HTML}\n"

          # 7. 添加外部容器的结束 HTML
          STAR_SHOWCASE_CONTENT="${STAR_SHOWCASE_CONTENT}</div>"

          # 8. 将最终内容输出为 GitHub Actions 环境变量
          echo "STAR_SHOWCASE_CONTENT<<EOF" >> $GITHUB_ENV
          echo "$STAR_SHOWCASE_CONTENT" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Update README
        # 将环境变量内容作为 awk 的外部变量 (Content) 传入
        # 这种方式比使用临时文件更简洁，且避免了 Shell 解释问题
        env:
          # 将我们在前一步生成的内容作为 env 变量传递给 run 块
          STAR_CONTENT: ${{ env.STAR_SHOWCASE_CONTENT }}
        run: |
          # Awk 命令的逻辑：
          # 1. 遇到 START 标记，打印它。
          # 2. 打印 awk 外部变量 Content 的值。
          # 3. 开启跳过模式 (skip=1)。
          # 4. 遇到 END 标记，关闭跳过模式 (skip=0)，并打印 END 标记。
          # 5. 如果 skip=0，则打印行。
          
          awk -v Content="${STAR_CONTENT}" '
            // { 
                print; 
                printf "%s", Content; # 打印新内容
                skip = 1; 
                next 
            }
            // { 
                skip = 0; 
            }
            skip == 0 { 
                print 
            }
          ' README.md > tmp && mv tmp README.md
          
      - name: Commit and push changes
        # 确保您的仓库有 write 权限
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # 检查是否有实际修改，避免空提交
          if git diff --exit-code README.md > /dev/null; then
              echo "No changes to commit"
          else
              git add README.md
              git commit -m "✨ Auto-update Star Showcase"
              git push
          fi
