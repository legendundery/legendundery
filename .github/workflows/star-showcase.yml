name: ğŸŒŸ Update Star Showcase
on:
  schedule:
    # æ¯å¤©æ—©ä¸Š 6 ç‚¹è¿è¡Œ
    - cron: '0 6 * * *'
  workflow_dispatch:

jobs:
  update-stars:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install jq
        # ä»ç„¶éœ€è¦ jq æ¥è§£æ JSON
        run: sudo apt-get install -y jq

      - name: Fetch starred repos and generate Content
        # ä½¿ç”¨å¤šè¡Œè„šæœ¬è·å–æ•°æ®ã€ç”Ÿæˆ HTML å¹¶å­˜å‚¨åœ¨ç¯å¢ƒå˜é‡ä¸­
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          # 1. åˆå§‹åŒ–å˜é‡ï¼ŒåŒ…å«æ ‡é¢˜
          STAR_SHOWCASE_CONTENT="## ğŸŒŸ Star Showcase\n\n"
          
          # 2. æ·»åŠ å¤–éƒ¨å®¹å™¨çš„èµ·å§‹ HTML
          STAR_SHOWCASE_CONTENT="${STAR_SHOWCASE_CONTENT}<div align=\"center\" style=\"display:flex; flex-wrap:wrap; justify-content:center;\">\n"

          # 3. æŠ“å–æ•°æ®
          STARRED_REPOS=$(curl -s -H "Authorization: token $GH_TOKEN" "https://api.github.com/users/legendundery/starred?per_page=6")
          
          # 4. å®šä¹‰ jq è„šæœ¬ï¼šä½¿ç”¨å•å¼•å·å¤šè¡Œå­—ç¬¦ä¸²æ¥å®šä¹‰æ¨¡æ¿ï¼Œå‡å°‘è½¬ä¹‰é—®é¢˜
          # æ³¨æ„ï¼šè¿™é‡Œçš„å•å¼•å·æ˜¯ jq çš„å­—ç¬¦ä¸²ï¼Œå†…å±‚çš„åŒå¼•å·æ˜¯ HTML å±æ€§ã€‚
          JQ_SCRIPT='
            .[] | "
            <div style=\"width:280px; margin:10px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.08); padding:15px; background:#fff; text-align:left;\">
                <a href=\"\(.html_url)\" target=\"_blank\" style=\"text-decoration:none; color:#0969da;\">
                    <h3>\(.full_name)</h3>
                </a>
                <p style=\"color:#555; font-size:13px;\">\(.description // "No description")</p>
                <p style=\"font-size:12px; color:#888;\">â­ \(.stargazers_count)</p>
            </div>"
          '
          
          # 5. æ‰§è¡Œ jq å¹¶å°†ç»“æœæ·»åŠ åˆ°å†…å®¹å˜é‡
          # ä½¿ç”¨ 'echo' å’Œ 'jq -r' å°†æ¨¡æ¿å’Œæ•°æ®ç»“åˆ
          CARD_HTML=$(echo "$STARRED_REPOS" | jq -r "$JQ_SCRIPT")
          
          # 6. å°†ç”Ÿæˆçš„å¡ç‰‡ HTML æ·»åŠ åˆ°å†…å®¹ä¸­
          STAR_SHOWCASE_CONTENT="${STAR_SHOWCASE_CONTENT}${CARD_HTML}\n"

          # 7. æ·»åŠ å¤–éƒ¨å®¹å™¨çš„ç»“æŸ HTML
          STAR_SHOWCASE_CONTENT="${STAR_SHOWCASE_CONTENT}</div>"

          # 8. å°†æœ€ç»ˆå†…å®¹è¾“å‡ºä¸º GitHub Actions ç¯å¢ƒå˜é‡
          echo "STAR_SHOWCASE_CONTENT<<EOF" >> $GITHUB_ENV
          echo "$STAR_SHOWCASE_CONTENT" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Update README
        # å°†ç¯å¢ƒå˜é‡å†…å®¹ä½œä¸º awk çš„å¤–éƒ¨å˜é‡ (Content) ä¼ å…¥
        # è¿™ç§æ–¹å¼æ¯”ä½¿ç”¨ä¸´æ—¶æ–‡ä»¶æ›´ç®€æ´ï¼Œä¸”é¿å…äº† Shell è§£é‡Šé—®é¢˜
        env:
          # å°†æˆ‘ä»¬åœ¨å‰ä¸€æ­¥ç”Ÿæˆçš„å†…å®¹ä½œä¸º env å˜é‡ä¼ é€’ç»™ run å—
          STAR_CONTENT: ${{ env.STAR_SHOWCASE_CONTENT }}
        run: |
          # Awk å‘½ä»¤çš„é€»è¾‘ï¼š
          # 1. é‡åˆ° START æ ‡è®°ï¼Œæ‰“å°å®ƒã€‚
          # 2. æ‰“å° awk å¤–éƒ¨å˜é‡ Content çš„å€¼ã€‚
          # 3. å¼€å¯è·³è¿‡æ¨¡å¼ (skip=1)ã€‚
          # 4. é‡åˆ° END æ ‡è®°ï¼Œå…³é—­è·³è¿‡æ¨¡å¼ (skip=0)ï¼Œå¹¶æ‰“å° END æ ‡è®°ã€‚
          # 5. å¦‚æœ skip=0ï¼Œåˆ™æ‰“å°è¡Œã€‚
          
          awk -v Content="${STAR_CONTENT}" '
            // { 
                print; 
                printf "%s", Content; # æ‰“å°æ–°å†…å®¹
                skip = 1; 
                next 
            }
            // { 
                skip = 0; 
            }
            skip == 0 { 
                print 
            }
          ' README.md > tmp && mv tmp README.md
          
      - name: Commit and push changes
        # ç¡®ä¿æ‚¨çš„ä»“åº“æœ‰ write æƒé™
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å®é™…ä¿®æ”¹ï¼Œé¿å…ç©ºæäº¤
          if git diff --exit-code README.md > /dev/null; then
              echo "No changes to commit"
          else
              git add README.md
              git commit -m "âœ¨ Auto-update Star Showcase"
              git push
          fi
